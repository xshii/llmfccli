# 工具多语言支持 (Tool Internationalization)

## 概述

从此版本开始，所有工具的描述和参数说明都支持中英文双语，确保 LLM 能够根据设定的语言理解工具用途。

## 快速使用

### 1. 环境变量（推荐）

```bash
# 使用英文
export CLAUDE_QWEN_LANG=en

# 使用中文（默认）
export CLAUDE_QWEN_LANG=zh

# 启动 CLI
claude-qwen
```

### 2. 配置文件

编辑 `config/language.yaml`：

```yaml
# 修改默认语言
default: en  # 或 zh

# 修改检测策略
detection: env  # 或 config, auto
```

### 3. 代码中动态设置

```python
from backend.i18n import I18n

# 设置为英文
I18n.set_language('en')

# 设置为中文
I18n.set_language('zh')

# 获取当前语言
current_lang = I18n.get_language()
```

## 语言检测策略

在 `config/language.yaml` 中配置：

- **env**: 从环境变量 `CLAUDE_QWEN_LANG` 读取，未设置则使用 default
- **config**: 始终使用配置文件中的 default 语言
- **auto**: 自动检测系统语言（中文系统使用 zh，其他使用 en）

## 支持的语言

| 语言代码 | 语言名称 |
|---------|---------|
| zh      | 简体中文 |
| en      | English |

## 工具描述示例

### view_file 工具

**中文 (zh)**:
```json
{
  "name": "view_file",
  "description": "读取文件内容（可指定行范围）",
  "parameters": {
    "path": "文件路径（相对于项目根目录或绝对路径）",
    "line_range": "可选的行范围 [start_line, end_line]（1-indexed，使用 -1 表示文件末尾）"
  }
}
```

**英文 (en)**:
```json
{
  "name": "view_file",
  "description": "Read file contents with optional line range",
  "parameters": {
    "path": "File path (relative to project root or absolute path)",
    "line_range": "Optional line range [start_line, end_line] (1-indexed, use -1 for end of file)"
  }
}
```

## 为新工具添加多语言支持

### 1. 定义工具描述

```python
class MyTool(BaseTool):
    @property
    def description_i18n(self) -> Dict[str, str]:
        return {
            'en': 'My tool description in English',
            'zh': '我的工具的中文描述'
        }
```

### 2. 定义参数描述

```python
def get_parameters_i18n(self) -> Dict[str, Dict[str, str]]:
    return {
        'param1': {
            'en': 'Parameter 1 description',
            'zh': '参数 1 的描述'
        },
        'param2': {
            'en': 'Parameter 2 description',
            'zh': '参数 2 的描述'
        }
    }
```

### 3. 完整示例

```python
from typing import Dict, Any
from pydantic import BaseModel, Field
from backend.tools.base import BaseTool

class MyToolParams(BaseModel):
    input_path: str = Field(description="Input file path")
    output_path: str = Field(description="Output file path")

class MyTool(BaseTool):
    @property
    def name(self) -> str:
        return "my_tool"

    @property
    def description_i18n(self) -> Dict[str, str]:
        return {
            'en': 'Process files and generate output',
            'zh': '处理文件并生成输出'
        }

    def get_parameters_i18n(self) -> Dict[str, Dict[str, str]]:
        return {
            'input_path': {
                'en': 'Input file path',
                'zh': '输入文件路径'
            },
            'output_path': {
                'en': 'Output file path',
                'zh': '输出文件路径'
            }
        }

    @property
    def parameters_model(self):
        return MyToolParams

    def execute(self, input_path: str, output_path: str) -> Dict[str, Any]:
        # 实现逻辑
        pass
```

## 测试

运行多语言测试：

```bash
python3 tests/unit/test_i18n.py
```

测试覆盖：
- ✓ 中文描述正确性
- ✓ 英文描述正确性
- ✓ 动态语言切换
- ✓ 所有文件系统工具的双语支持
- ✓ 环境变量配置生效

## 架构设计

### I18n 类

核心国际化管理器，提供：
- `initialize()`: 初始化语言设置
- `get_language()`: 获取当前语言
- `set_language()`: 设置当前语言
- `translate()`: 翻译文本

### BaseTool 集成

- `description` 属性自动使用 `description_i18n` 翻译
- `get_openai_schema()` 方法自动替换参数描述
- 保持向后兼容，无需修改现有代码

## 最佳实践

1. **一致性**: 确保所有工具都提供完整的中英文描述
2. **简洁性**: 描述要简洁明了，准确传达工具用途
3. **专业性**: 使用专业术语，保持技术准确性
4. **测试**: 添加新工具后运行 `test_i18n.py` 验证

## 常见问题

### Q: 如何临时切换语言？
A: 使用 `I18n.set_language('en')` 或 `I18n.set_language('zh')`

### Q: 如何确认当前使用的语言？
A: 运行 `I18n.get_language()` 查看

### Q: 参数描述没有更新？
A: 确保工具类实现了 `get_parameters_i18n()` 方法，并且重新初始化了 registry

### Q: 如何添加新语言（如日文）？
A:
1. 在 `I18n.SUPPORTED_LANGUAGES` 中添加语言代码
2. 为所有工具添加对应语言的描述
3. 更新 `config/language.yaml` 和测试

## 相关文件

- `backend/i18n.py`: 国际化核心模块
- `backend/tools/base.py`: 工具基类
- `config/language.yaml`: 语言配置
- `tests/unit/test_i18n.py`: 多语言测试
- `scripts/update_tools_i18n.py`: 批量更新工具脚本
