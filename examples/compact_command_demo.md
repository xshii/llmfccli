# /compact 命令使用示例

## 功能概述

`/compact` 命令提供智能的上下文压缩功能，支持按 token 比例要求压缩历史关键信息。

## 使用方式

### 1. 查看压缩策略（不执行压缩）

```
> /compact --info
```

输出示例：
```
┏━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━┓
┃ 模块               ┃ 当前使用 ┃  预算  ┃  占比  ┃   状态   ┃
┡━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━┩
│ active_files       │    5,234 │ 32,000 │  16.4% │ ✓        │
│ processed_files    │    2,100 │ 19,200 │  10.9% │ ✓        │
│ project_structure  │      892 │  6,400 │  13.9% │ ✓        │
│ compressed_history │   42,000 │ 38,400 │ 109.4% │ ⚠ 超预算 │
│ recent_messages    │   35,000 │ 32,000 │ 109.4% │ ⚠ 超预算 │
│ 总计               │   85,226 │128,000 │  66.6% │ ⚠ 需压缩 │
└────────────────────┴──────────┴────────┴────────┴──────────┘

压缩策略说明:
- 触发阈值: 85%
- 目标比例: 60%
- 最小间隔: 300秒

各模块预算分配:
  active_files        :  25.0% (  32,000 tokens)
  processed_files     :  15.0% (  19,200 tokens)
  project_structure   :   5.0% (   6,400 tokens)
  compressed_history  :  30.0% (  38,400 tokens)
  recent_messages     :  25.0% (  32,000 tokens)
```

### 2. 使用默认策略压缩（压缩到 60%）

```
> /compact
```

输出示例：
```
┏━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━┳━━━━━━━━━━┓
┃ 模块               ┃ 当前使用 ┃  预算  ┃  占比  ┃   状态   ┃
┡━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━╇━━━━━━━━━━┩
│ active_files       │    5,234 │ 32,000 │  16.4% │ ✓        │
│ processed_files    │    2,100 │ 19,200 │  10.9% │ ✓        │
│ project_structure  │      892 │  6,400 │  13.9% │ ✓        │
│ compressed_history │   42,000 │ 38,400 │ 109.4% │ ⚠ 超预算 │
│ recent_messages    │   35,000 │ 32,000 │ 109.4% │ ⚠ 超预算 │
│ 总计               │   85,226 │128,000 │  66.6% │ ⚠ 需压缩 │
└────────────────────┴──────────┴────────┴────────┴──────────┘

压缩目标: 85,226 → 76,800 tokens (60%)
预计节省: 8,426 tokens

正在压缩上下文...

✓ 压缩完成

┏━━━━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━┓
┃ 项目         ┃   压缩前 ┃   压缩后 ┃             变化 ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━┩
│ 消息数量     │       45 │       12 │              -33 │
│ 总 Token 数  │   85,226 │   74,521 │ -10,705 (12.6%)  │
│ 使用率       │    66.6% │    58.2% │           -8.4%  │
└──────────────┴──────────┴──────────┴──────────────────┘

保留信息:
  - 活动文件: 3 个
  - 项目结构: /home/user/llmfccli
  - 最近消息: 12 条
  - 工具定义: 已重新注入
```

### 3. 指定压缩比例（压缩到 50%）

```
> /compact 0.5
```

输出示例：
```
压缩目标: 85,226 → 64,000 tokens (50%)
预计节省: 21,226 tokens

正在压缩上下文...

✓ 压缩完成

┏━━━━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━┓
┃ 项目         ┃   压缩前 ┃   压缩后 ┃             变化 ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━┩
│ 消息数量     │       45 │        8 │              -37 │
│ 总 Token 数  │   85,226 │   62,341 │ -22,885 (26.9%)  │
│ 使用率       │    66.6% │    48.7% │          -17.9%  │
└──────────────┴──────────┴──────────┴──────────────────┘

保留信息:
  - 活动文件: 3 个
  - 项目结构: /home/user/llmfccli
  - 最近消息: 8 条
  - 工具定义: 已重新注入
```

## 工作原理

### Token 预算分配（基于 config/token_budget.yaml）

```yaml
budgets:
  active_files: 0.25        # 25% - 当前文件 + 单元测试（不可压缩）
  processed_files: 0.15     # 15% - 历史文件摘要
  project_structure: 0.05   #  5% - 目录树（不可压缩）
  compressed_history: 0.30  # 30% - 压缩的对话历史
  recent_messages: 0.25     # 25% - 最近的未压缩消息
```

### 压缩策略

1. **触发条件**：
   - Token 使用率达到 85% 时自动触发
   - 或手动使用 `/compact` 命令

2. **压缩过程**：
   - 保留最近 N 条重要消息
   - 保留所有活动文件信息
   - 保留项目结构信息
   - 将旧消息压缩为摘要
   - 重新注入工具定义

3. **压缩目标**：
   - 默认压缩到总容量的 60%
   - 可自定义压缩比例 (0-1)

### 保留的信息

压缩后始终保留：
- ✅ 活动文件列表和内容
- ✅ 项目目录结构
- ✅ 最近的对话消息
- ✅ 关键决策点
- ✅ 工具定义（自动重新注入）
- ✅ 压缩后的历史摘要

## 使用场景

### 场景 1: 长时间编程会话

当进行长时间的开发工作时，对话历史会不断累积：

```bash
# 查看当前压缩策略和使用情况
/compact --info

# 手动压缩
/compact

# 压缩后再次检查
/compact --info
```

### 场景 2: 多文件重构

在处理多个文件时，活动文件会占用大量 tokens：

```bash
# 查看策略
/compact --info

# 主动压缩到 50%，留更多空间给新文件
/compact 0.5

# 继续处理更多文件
```

### 场景 3: 压缩前预览

在执行压缩前，先查看会发生什么：

```bash
# 查看当前状态和预算分配
/compact --info

# 确认策略后再压缩
/compact
```

## 配置文件

可以通过编辑 `config/token_budget.yaml` 来自定义压缩行为：

```yaml
token_management:
  max_tokens: 128000        # 最大 token 容量

  budgets:
    active_files: 0.25      # 调整各模块预算比例
    processed_files: 0.15
    project_structure: 0.05
    compressed_history: 0.30
    recent_messages: 0.25

  compression:
    trigger_threshold: 0.85  # 调整自动触发阈值
    target_after_compress: 0.6  # 调整压缩目标
    min_interval: 300        # 调整最小压缩间隔
```

## 常见问题

### Q: 压缩会丢失信息吗？

A: 不会丢失关键信息。压缩会：
- 保留所有活动文件
- 保留最近的对话
- 将旧对话总结为摘要
- 保留重要的决策点

### Q: 可以撤销压缩吗？

A: 不能。压缩是不可逆的。建议：
- 使用 `/compact --info` 先查看
- 重要会话前不要压缩
- 或使用较温和的比例（如 0.7）

### Q: 何时应该手动压缩？

A: 以下情况建议手动压缩：
- Token 使用率接近 80%
- 准备处理大型文件
- 会话已经很长，但还要继续
- 想清理历史，专注新任务

### Q: 工具定义会丢失吗？

A: 不会。每次压缩后都会自动重新注入工具定义，确保 Agent 功能完整。

## 高级技巧

### 1. 渐进式压缩

对于特别长的会话，可以分步压缩：

```bash
/compact 0.7  # 先压缩到 70%，保留更多信息
# 工作一段时间...
/compact 0.6  # 再压缩到 60%
# 继续工作...
/compact 0.5  # 最后压缩到 50%，最大化可用空间
```

### 2. 监控和压缩流程

```bash
# 监控流程
/compact --info # 检查使用率
# 工作...
/compact --info # 再次检查是否需要压缩
/compact        # 执行压缩
/compact --info # 确认结果
```

### 3. 预防性压缩

在处理大任务前主动压缩：

```bash
# 准备分析一个大型 C++ 项目
/compact 0.5  # 先压缩到 50%，留足空间
# 现在可以放心处理大量文件
```

## 相关命令

- `/compact --info` - 查看详细的 Token 使用情况和压缩策略
- `/clear` - 完全清除对话历史（不推荐，会丢失所有上下文）
- `/compact` - 智能压缩（推荐）
